version: '3.3'

services:

  server:
    image: freeipa/freeipa-server:fedora-24
    hostname: 'ldap.example.test'
    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:ro
      - data:/data
    tmpfs:
      - /run
      - /tmp
    networks:
      - core
      {% if grains['traefik-enabled'] == true -%}
      - traefik_backend
      {%- endif %}
    ports:
      - {{ grains['ipv4']|last }}:53:53/udp
      - {{ grains['ipv4']|last }}:53:53
      - 88:88
      - 88:88/udp
      - 389:389
      - 464:464
      - 464:464/udp
      - 636:636
      - 7389:7389
      - 9443:9443
      - 9444:9444
      - 9445:9445
    restart: unless-stopped
    privileged: true
    command: '-U --realm EXAMPLE.TEST --no-ntp --no_hbac_allow --ds-password=cdi@1234 --admin-password=cdi@1234'
    environment:
      - "IPA_SERVER_HOSTNAME=ldap.example.test"
      - "TZ=America/Toronto"
      - "PASSWORD=cdi@1234"
      - "IPA_SERVER_IP={{ grains['ipv4']|last }}"
      - "DEBUG_TRACE=1"
    {% if grains['traefik-enabled'] == true -%}
    labels:
      - traefik.enable=true
      - traefik.docker.network=traefik_backend
      - traefik.http.port=80
      - traefik.https.port=443
      - traefik.frontend.rule=Host:ldap.example.test;Path:/ipa/ui
    {%- endif %}

volumes:
  data:

networks:
  core:
  {% if grains['traefik-enabled'] == true -%}
  traefik_backend:
    external: true
  {%- endif %}